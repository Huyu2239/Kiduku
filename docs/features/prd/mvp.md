# MVP PRD - Kiduku

## 1. MVP概要

Kidukuの最小実装版として、Discord内のメンション確認状況を可視化する基本機能を実装する。

## 2. MVP対象ユースケース

- **UC01**: メッセージのメンション確認をリアクションで可視化する
- **UC02**: 未読ユーザーをコマンドで確認する

## 3. MVP機能一覧

### 3.1 既読リアクション管理

**機能名**: メッセージへの既読リアクション自動付与

**説明**:
- Botがメンション（@everyone, @here, ユーザーメンション, ロールメンション）を含むメッセージを検出
- 自動的に「✅」（チェックマーク）リアクションを付与
- このリアクションに対してユーザーが反応（絵文字を追加）することで既読状態を記録

**要件**:
- メッセージイベント(MessageCreate)で自動検出
- メンション判定ロジック：以下いずれかを含む
  - ユーザーメンション (@user)
  - ロールメンション (@role)
  - @everyone
  - @here
- リアクション追加時の例外処理（権限不足、既に追加済み など）
- ボット自身のメッセージには反応しない

**対象チャンネル**: サーバー内全チャンネル（管理者が後で制限可能）

### 3.2 既読状態確認コマンド

**機能名**: `/check-reads` スラッシュコマンド

**説明**:
- コマンド実行者が直近で送信したメンションメッセージの既読状況を表示
- 既読ユーザーと未読ユーザーをリスト表示

**要件**:
- コマンド構文: `/check-reads [hours]`
  - `hours` (オプション): デフォルト24時間、過去何時間のメッセージを対象にするか
- 出力形式:
  - メッセージURL
  - メッセージ内容（最初の100文字など）
  - 既読ユーザー一覧（リアクション追加者）
  - 未読ユーザー一覧（メンション対象だが未反応）
- 一時的メッセージ(ephemeral)で返す（実行者のみ表示）
- メッセージが無い場合のエラーハンドリング

### 3.3 ヘルプコマンド

**機能名**: `/help` スラッシュコマンド

**説明**:
- Botの使用方法を表示

**要件**:
- Botの概要説明
- 利用可能なコマンド一覧と説明
- 使用例

## 4. 非機能要件

### スケーラビリティ
- 複数サーバー（Guild）での同時動作を想定
- メッセージ処理は非同期（tokio）で実行
- MVP では単一ボットトークンでの運用を想定（シャーディング不要）

### 信頼性
- ネットワークエラー時：Serenity の自動リコネクション機能に依存
- Discordの レート制限：Serenity が自動処理（リトライ実装不要）
- リアクション付与失敗時：ログ出力のみ、処理継続（エラーを通知しない）

### ログ
- コマンド実行: `info!` レベルでログ
- エラー発生: `error!` レベルでログ
- 詳細トレース: `debug!` レベルでログ（開発時のみ有効）

### パフォーマンス
- メッセージ処理：<100ms を目標（リアクション付与遅延を最小化）
- コマンド実行: <1s を目標

## 5. 実装上の注意点

### 権限・API制限
- Botはメッセージが投稿されたチャンネルでの**リアクション追加権限**が必須
  - 権限不足時はログ出力、ユーザーには通知しない
- スラッシュコマンド実行には特別な権限は不要

### リアクション絵文字
- 「✅」（Unicode チェックマーク）で固定
- カスタマイズはフェーズ2以降の機能

### データ管理
- 既読情報はDiscordのリアクション情報そのものを使用
- 別途 DB での保存は不要（Phase 2 以降で分析が必要になった場合に検討）
- ボット再起動によるデータ損失なし（Discord側で管理）

### ロール展開の制限
- ロールメンション対象のロール内メンバー上限：50名程度を想定
- 大規模サーバー（1000+メンバー）でのロールメンション時は遅延の可能性あり
- Phase 2 でキャッシング導入を検討

## 6. MVP 制約事項

- **保存機能なし**: 既読情報の永続化は行わない
- **分析機能なし**: 既読率・傾向分析は対象外
- **設定機能なし**: チャンネルごとの有効/無効、リアクション絵文字カスタマイズはなし
- **通知機能なし**: 未読ユーザーへの DM 通知はなし
- **複数言語対応なし**: 日本語のみ

## 7. Phase 2以降の予定機能（MVP外）

- 未読ユーザーへのDM通知機能
- リアクション絵文字のカスタマイズ
- チャンネルごとの有効/無効設定
- 既読情報の分析・レポート機能
- 多言語対応
- GUI ダッシュボード
